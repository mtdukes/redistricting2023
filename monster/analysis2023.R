# A project script to organize code for analysis of redistricting maps in
# North Carolina during the 2023 redistricting cycle using techniques and
# map ensembles generated by the Duke Quantifying Gerrymandering team.


# Initial setup -----------------------------------------------------------

# load libraries
library(tidyverse)
library(tidycensus)
library(janitor)

# set api key for tidycensus
census_api_key(read_lines('keys/census_api', n_max = 1))

#turn off scientific notation
options(scipen = 999)

# Load census files -------------------------------------------------------

# load block level files on NC population from tidycensus
nc_population_block <- get_decennial(geography = "block",
              state = 'NC',
              variables = "P1_001N", 
              year = 2020,
              sumfile = "pl") %>% 
  select(geoid = GEOID, population = value)

# readout check of block totals
cat('...loaded', nrow(nc_population_block), 'total blocks...',
    if_else(nrow(nc_population_block) == 236638, 'CHECK', 'ERROR')
)
# readout of population check
cat('...total population', sum(nc_population_block$population), '...',
    if_else(sum(nc_population_block$population) == 10439388, 'CHECK', 'ERROR')
)

# Load Duke precinct vote to block crosswalk ------------------------------

# The crosswalk file created by the Duke University team contains the vote breakdown
# for multiple statewide races by block, based on precinct level election results
duke_crosswalk <- read_csv('../data/block_precinct_vote_crosswalk.csv') %>%
  clean_names('snake') %>% 
  #fix the ss to sst error for 2012
  rename(g12_sst_d = g12_ss_d, g12_sst_r = g12_ss_r)
